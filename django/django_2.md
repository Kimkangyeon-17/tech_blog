# Django 기초

two scoops of django의 6장 장고에서 모델 이용하기 파트를 정리, 요약해보겠습니다.

## django에서 모델 이용하기
모델은 django의 토대가 되는 부분입니다. 때문에 모델을 개발할 때 덕지덕지 땜질하듯 개발하거나 임시방편의 설계들은 몇달 혹은 몇년 후에 문제를 야기할 수도 있습니다.
따라서 새로운 모델을 추가하거나 기존 모델을 수정할 때는 프로젝트 전체를 탄탄하고 안전하게 다질 수 있는 방향으로 디자인 해야 합니다.
 
1. 모델이 너무 많으면 앱을 나눕니다.
앱 하나에 모델이 20개 이상 있다면 앱이 너무 많은 일을 하고 있기 때문에 작은 앱으로 분리하는 것을 고려해야 할 것입니다. 

2. 모델 상속에 주의합니다.
django에서 모델은 3가지 방식으로 상속을 받을 수 있습니다.
아래 표를 통해서 상속을 받지 않는 경우와 각 상속 받는 방법의 장, 단점을 비교해보도록 하겠습니다.

### 모델 상속 종류와 장, 담점

| 모델 상속 스타일 | 장점 | 단점|
| --------- | ------- | --- |
| 상속을 하진 않는 경우 (모델들 사이에 공통 필드가 존재할 경우 두 모델에 전부 해당 필드를 만들어 줌) | 데이터 베이스테이블에 어떤 식으로 매핑 되든지 상관 없이 장고 모델을 한 눈에 이해하기 쉬움 | 모델들 사이에 서로 중복되는 테이블이 많을 경우 이를 지속적으로 관리하기 어려움 |
| 추상화 기초 클래스 (오직 상속받아 생성된 모델들의 테이블만 생성) | 츄상화된 클래스에 공통적인 부분을 추려 놓음으로써 한 번만 타이핑을 하면 됨, 추가 테이블이 생성되지 않고 여러 테이블에 걸쳐 조인을 함으로써 발생하는 성능 저하도 없음 | 부모 클래스를 독립적으로 이용할 수 없음 |
| 멀티테이블 상속 (자식 모델에 대해서도 모두 테이블 생성, OneToOneField는 부모와 자식 간에 적용) | 각 모델에 대해 매칭되는 테이블이 생성 됨, 부모 또는 자식 모델 어디로든지 쿼리를 할 수 있음, 부모 객체로부터 자식 객체를 호출하는 것이 가능 | 자식 테이블에 대한 각 쿼리에 대해 부모 테이블로의 조인이 필요하므로 이에 따른 상당한 부하가 발생, 멀티테이블 상속을 이용하지 않기를 권함 |
| 프락시 모델 (원래 모델에 대해서만 테이블 생성) | 각기 다른 파이썬 작용을 하는 모델의 별칭을 가질 수 있음 | 모델의 필드 변경 가능 |

- 모델 사이에서 중복되는 내용이 최소이면 모델의 상속 자체가 필요하지 않을 것, 그냥 두 모델에 필드 추가합니다.
- 모델들 사이에 중복된 필드가 혼란을 야기하거나 의도하지 않은 실수를 유발할 정도로 많을 경우 공통 필드 부분이 추상화 기초 모델로 이전될 수 있도록 리팩토링합니다.
- 프락시 모델은 종종 편리하짐나 다른 두 가지 모델 상속 방식과는 다르게 작동한다는 점을 유의해야 합니다.
- 멀티 모델 상속은 혼란과 상당한 부하를 일으키므로 반드시 피하도록 합니다. 멀티모델 상속을 사용하는 대신 모델들 사이에서 좀 더 명확한 OneToOneField와 ForeignKeys를 이용하여 조인이 난립할 때 좀 더 수월하게 컨트롤할 수 있습니다.

### 데이터 베이스 마이그레이션
새로운 앱이나 모델이 생성되면 새 모델에 대해 `django.db.migrations` 혹은 `python manage.py makemigrations`를 통해 실행할 수 있습니다.

마이그레이션을 배포 관리할 때는 되돌릴 수 있는지 확인해야 합니다. 완변한 복구가 아닌 적정 수준까지 되돌리기도 불가능하다면 규모가 큰 프로젝트에서는 버그 트래킹이나 배포 시에 큰 문제가 될 수 있습니다.
테이블에 수백만개의 데이터가 이미 존재한다면 운영 서버에서 실제로 마이그레이션을 실행하기 전에 스테이징 서버에서 충분한 테스트가 필요합니다.
또한, MySQL울 사용하는 경우 MySQL은 스키마 변경에 대해 트랜잭션을 지원하지 않기 때문에 스키마를 변환하기 전에 데이터베이스를 반드시 백업해 두어야 합니다.

## django 모델 디자인 
django 모델 디자인은 항상 정규화부터 신경써야 합니다.
이미 모델에 포함된 데이터를 중복되어 다시 모델에 포함되지 않도록 신경써야 합니다.
또한 적절한 위치에서 캐시를 세팅하는 것은 모델을 비정규화 할 때 발생하는 문제점들의 상당 부분을 해결해 주기도 합니다.

모델의 필드를 정의 할 때 `null=True`와 `blank=True`를 설정하는 옵션을 선택할 수 있습니다. 기본 값은 둘 다 `False`입니다.

아래는 모델 필드 인자들에 대한 일반적인 가이드입니다.

### 모델 필드 인자 가이드

| 필드 타입 | null=True 설정하기 | blank=True 설정하기 | 
| ---- | ---- | ---- |
| CharField, TextField, SlugField, EmailField, CommaSeparatedInterger Field, UUIDField | 이용하지 않음 | 위젯이 빈값을 허용하기를 원할 때 설정, 그 경우 DB에 빈 값이 문자열로 저장 됨 |
| FileField, ImageField | 이용하지 않음 | 위와 동일함 |
| BooleanField | 이용하지 않음 | 이용하지 않음 |
| IntegerField, FloatField, DecimalField, DurationField | 해당 값이 DB에 Null로 들어가도 문제가 없을 경우 사용 | 위젯에서 빈 값을 받아와도 문제가 없다면 이용, 그럴 경우 null=True와 함께 사용 |
| DateTimeField, DateField, TimeField | DB에 해당 값들을 Null로 설정하는 것이 가능할 때 이용 | 위젯에서 해당 값이 빈 값을 받아와도 문제가 없거나 auto_now,auto_now_add를 이용할 경우 사용, 그럴 경우 null=True와 함께 사용 |
| Foreignkey, ManyToManyField, OneToOneField | DB에 해당 값들을 Null로 설정하는 것이 가능할 때 이용 | 위젯에서 해당 값이 빈 값을 받아와도 괜찮다면 이용 |
| GenericIPAddressField | DB에 해당 값들을 Null로 설정하는 것이 가능할 때 이용 | 위젯에서 해당 값이 빈 값을 받아와도 괜찮다면 이용 |
| IPAddressField | 이용하지 않음 | 이용하지 않음 |

- BinaryField는 메시지팩 형식의 콘텐츠, 원본 센서 데이터, 압축 데이터 등을 저장할 때 사용될 수 있습니다.

### 범용 관계
찬 테이블로부터 다른 테이블을 서로 제약 조건이 없는 외부키로 바인딩 하는 것입니다.
범용 관계와 GenericForeignKey 이용은 피합니다. 범용 관계가 필요하다면 모델 디자인을 새로 바꾸거난 PostgreSQL 필드를 통해 해결할 수 있는지 확인합니다. 불가피하게 이용해야 하는 경우 서트 파티 앱을 사용하는 것을 고려해 봅니다. 독립적인 외부 앱의 경우 데이터들을 깔끔하게 유지하는 데 도움이 됩니다.

### PostgreSQL에만 존재하는 필드에 대해 null을 쓰는 경우
| 필드 타입 | null=True | blank=True |
| ---- | ---- | ---- |
| ArrayField | 가능 | 가능 |
| HStoreField | 가능 | 가능 |
| IntegerRangeField, BigIntegerRangeField, FloatRangeField | DB에서 해당 값들을 Null로 설정할 수 있다면 가능 | 위젯에서 해당하는 폼이 빈 값을 허용하기를 원한다면 null=True와 함께 사용 가능 |
| DateTimeRangeField, DateRangerField | DB에서 해당 값들을 Null로 설정할 수 있다면 가능 | 위젯에서 해당하는 촘이 빈 값을 허용하기를 원할 경우 또는 auto_now, auot_now_add를 이용하고 있다면 가능, 이 때 null=True와 함께 사용 |

## 거대 모델
거대 모델이란 데이터 관련 코드를 view나 template에 넣기보다는 모델 메서드, 클래스 메서드, 프로퍼터 심지어는 매니저 메서드 안에 넣어 캡술화하는 것입니다.
이럴 경우 어떤 view나 여타 작업에서 같은 로직을 이용할 수 있기 때문입니다.

거대 모델은 프로젝트 전체를 통해 코드 재사용을 개선할 수 있는 최고의 방법입니다.


## 요약
- 모델은 django 프로젝트의 기초가 되는 부분입니다. 따라서 모델을 디자인 할 때는 신중하게 디자인해야 합니다. 
- 정규화를 시작하고 다른 선택지를 충분히 고려하고 나서도 방법이 없을 때만 비정규화를 고려해야 합니다.
- 모델 간의 상속을 이용할 때는 접합 모델이 아니라 추상화 기초 클래스로부터 상속을 사용해야 합니다.
- 모델에서 `null=True`와 `blank=True` 옵션을 이용할 때는 주의해야 합니다.


## djagno 모델을 작업하면서 이용할 수 있는 유용한 패키지들
- djagno-model-utils : 일반적인 패턴을 처리하는 데 이용
- django-extensions : 모든 앱에서 모델 클래스를 자동으로 로드해주는 shell_plus라는 강력한 관리 명령 제공, 단점은 우리가 지향하는 '작지만 역할이 분명한 앱' 개념에 맞지 않게 다양한 기능을 가지고 있음